"""
Recommender Agent
-----------------
Fetches stock data via Yahoo Finance and gives simple Buy/Hold/Sell recommendations.
"""

from flask import Flask, request, jsonify
import yfinance as yf

app = Flask(__name__)

STOCKS = {
    "Finance": ["JPM", "BAC", "GS", "MS"],
    "Tech": ["AAPL", "MSFT", "GOOG", "NVDA"],
    "Healthcare": ["PFE", "JNJ", "MRK", "UNH"]
}

@app.route('/recommend', methods=['POST'])
def recommend_stocks():
    data = request.json
    domain_reports = data.get("domain_reports", [])
    recommendations = []

    for report in domain_reports:
        domain = report.get("domain")
        sentiment = 1 if report.get("sentiment") == "positive" else 0.5
        tickers = STOCKS.get(domain, [])

        for ticker in tickers:
            stock = yf.Ticker(ticker)
            hist = stock.history(period="1mo")
            if hist.empty:
                continue
            short_ma = hist["Close"].tail(5).mean()
            long_ma = hist["Close"].tail(20).mean()
            momentum = (short_ma - long_ma) / long_ma
            score = (0.6 * momentum) + (0.4 * sentiment)
            rating = "Buy" if score > 0.05 else "Hold" if score > -0.02 else "Sell"

            recommendations.append({
                "ticker": ticker,
                "domain": domain,
                "momentum": round(momentum, 3),
                "sentiment": sentiment,
                "score": round(score, 3),
                "rating": rating
            })

    recommendations = sorted(recommendations, key=lambda x: x["score"], reverse=True)
    return jsonify({"recommendations": recommendations[:5]})

if __name__ == '__main__':
    app.run(port=5009)
